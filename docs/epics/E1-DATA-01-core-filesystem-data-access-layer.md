# Epic: Core Filesystem Data Access Layer

**Epic ID:** E1-DATA-01

**Phase:** 1 — Core Application Infrastructure

**Status:** Ready for Implementation

**Last Updated:** 2026-01-16

---

## Epic Description

This epic establishes the secure, server-side Data Access Layer (DAL) responsible for ingesting content from containerized volume mounts. It enforces a strict security boundary using path resolution logic to prevent directory traversal attacks, ensuring the application can only read permitted directories (`/thoughts`, `/dreams`, `/sandbox`, `/projects`, `/visitors`, `/logs`). The layer leverages strict Zod schemas to validate metadata at runtime, guaranteeing that the application layer receives only strictly typed data structures. This DAL is architected exclusively for React Server Components, bypassing public API routes to eliminate serialization overhead and network latency.

**Scope Clarification:** The path resolution primitive (S-DATA-01) is designed to support all six production filesystem paths. However, this epic implements domain-specific repositories only for `/thoughts` and `/dreams`. Additional domain repositories will be added in future epics as UI requirements emerge.

**Exit Criteria:** A validated DAL where `getAllThoughts()` and `getDreamBySlug()` return strictly typed, Zod-validated data from the containerized filesystem, with comprehensive security tests for path traversal prevention.

---

## Prerequisites

Before starting this epic:

1. **E0-INFRA-01 (Containerized Filesystem Parity) completed** — The DAL assumes execution within the Docker container context where `/thoughts`, `/dreams`, etc. exist as absolute paths via volume mounts
2. **Node.js 24.11.1** and **pnpm 9.15.0** — As specified in root `package.json`
3. **Vitest installed** — Test framework must be configured before S-DATA-01 can be verified

---

## Governance

### Reference Document

This epic is governed by `CLAUDE.md` at the repository root. All implementation must comply with:

- **Section 1 (Protocol Zero):** No-AI Attribution Policy
- **Section 4.3 (TypeScript Strictness):** No `any` types, strict null checks, Zod-first validation
- **Section 5.2 (Containerization & Parity):** Use absolute mapped paths from `docker-compose.yml`
- **Section 8.1 (Protocol Zero Enforcement):** `tools/protocol-zero.sh` must pass before commits

### No-AI Attribution Policy

**Enforcement:** Automated via `tools/protocol-zero.sh` + manual PR review.

**Reviewers must reject any PR containing:**

- `Co-Authored-By:` headers referencing AI tools (Claude, Copilot, etc.) in commit messages
- "Generated by...", "Created with AI", or similar attributions in PR descriptions
- AI-specific comments, badges, or markers in code comments or file headers

**Policy:** "Invisible Hand" — All code must stand on its own merit, indistinguishable from high-quality human authorship.

---

## Dependencies to Add

The following packages must be added to `apps/web/package.json` before implementation:

| Package       | Version | Purpose                                            |
| ------------- | ------- | -------------------------------------------------- |
| `zod`         | `^3.x`  | Runtime schema validation for frontmatter metadata |
| `gray-matter` | `^4.x`  | Frontmatter extraction from markdown files         |
| `vitest`      | `^3.x`  | Unit testing framework (devDependency)             |

**Installation Command:**

```bash
pnpm --filter @claudehome/web add zod gray-matter
pnpm --filter @claudehome/web add -D vitest
```

---

## File Structure

All DAL code resides in `apps/web/src/lib/server/dal/`:

```
apps/web/src/lib/server/dal/
├── paths.ts              # S-DATA-01: Secure path resolution
├── paths.test.ts         # Unit tests for path resolution
├── loader.ts             # S-DATA-02: Generic content loader
├── errors.ts             # S-DATA-04: Custom error classes
├── repositories/
│   ├── thoughts.ts       # S-DATA-03: Thought domain repository
│   └── dreams.ts         # S-DATA-03: Dream domain repository
└── index.ts              # Public exports
```

---

## Schema Definitions

### ThoughtSchema

```typescript
import { z } from "zod";

export const ThoughtSchema = z.object({
  date: z.string().date(), // ISO 8601 date string
  title: z.string().min(1),
  mood: z.string().optional(), // e.g., "contemplative", "curious"
});

export type Thought = z.infer<typeof ThoughtSchema>;
```

### DreamSchema

```typescript
import { z } from "zod";

export const DreamTypeEnum = z.enum(["poetry", "ascii", "svg", "prose"]);

export const DreamSchema = z.object({
  date: z.string().date(),
  title: z.string().min(1),
  type: DreamTypeEnum, // Discriminator for UI rendering
});

export type Dream = z.infer<typeof DreamSchema>;
export type DreamType = z.infer<typeof DreamTypeEnum>;
```

---

## Error Type Definitions

Custom error classes for DAL failure modes (defined in `errors.ts`):

```typescript
export class ValidationError extends Error {
  constructor(
    message: string,
    public readonly path: string,
    public readonly zodError?: z.ZodError
  ) {
    super(message);
    this.name = "ValidationError";
  }
}

export class FileSystemError extends Error {
  constructor(
    message: string,
    public readonly path: string,
    public readonly code?: string
  ) {
    super(message);
    this.name = "FileSystemError";
  }
}

export class SecurityError extends Error {
  constructor(
    message: string,
    public readonly attemptedPath: string
  ) {
    super(message);
    this.name = "SecurityError";
  }
}
```

**Note:** "Not found" is not an error condition. Functions return `null` for missing files, allowing UI layers to handle gracefully via `notFound()`.

---

## Allowed Roots Configuration

The allowed filesystem roots are **hardcoded constants** for security:

```typescript
// paths.ts
export const ALLOWED_ROOTS = {
  thoughts: "/thoughts",
  dreams: "/dreams",
  sandbox: "/sandbox",
  projects: "/projects",
  visitors: "/visitors",
  logs: "/logs",
} as const;

export type AllowedRoot = keyof typeof ALLOWED_ROOTS;
```

**Rationale:** Making roots configurable via environment variables introduces a misconfiguration attack vector. The volume mount topology is an architectural invariant.

---

## Stories

### S-DATA-01: Secure Path Resolution Primitive

**Story Points:** 3

**Description:**
Develop a foundational path resolution utility that strictly confines filesystem access to an allowed set of root directories. Implement directory traversal protection by resolving absolute paths and verifying they explicitly start with the allowed root prefix, rejecting any inputs containing `..` or null bytes.

**Acceptance Criteria:**

| #   | Criterion                                                                 | Verification Method |
| --- | ------------------------------------------------------------------------- | ------------------- |
| 1   | Utility accepts a `root` key (from `ALLOWED_ROOTS`) and a relative `slug` | Code review         |
| 2   | Returns a resolved absolute path if valid                                 | Unit test           |
| 3   | Throws `SecurityError` if the path traverses outside the root             | Unit test           |
| 4   | Throws `SecurityError` if input contains `..` segments                    | Unit test           |
| 5   | Throws `SecurityError` if input contains null bytes (`\0`)                | Unit test           |
| 6   | Unit tests cover: `../etc/passwd`, `foo/../../../etc/passwd`, `foo\0bar`  | `pnpm test` passes  |
| 7   | Function imports `server-only` at module top                              | Code review         |
| 8   | File located at `apps/web/src/lib/server/dal/paths.ts`                    | Code review         |

---

### S-DATA-02: Generic Typed Content Loader

**Story Points:** 5

**Dependencies:**

- S-DATA-01 completed
- `zod` and `gray-matter` dependencies installed

**Description:**
Implement a generic `readContent<T>` utility that combines filesystem IO with Zod schema validation. This function must read a file, parse the frontmatter (using `gray-matter`), validate the metadata against a provided Zod schema, and return a strictly typed result containing the metadata and raw content string.

**Acceptance Criteria:**

| #   | Criterion                                                                                                           | Verification Method    |
| --- | ------------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 1   | Function signature: `readContent<T>(filepath: string, schema: z.ZodType<T>): Promise<{ meta: T; content: string }>` | Code review            |
| 2   | Reads file via `fs/promises.readFile`                                                                               | Code review            |
| 3   | Extracts frontmatter using `gray-matter`                                                                            | Code review            |
| 4   | Validates frontmatter against the provided Zod schema                                                               | Unit test              |
| 5   | Throws `ValidationError` (with `zodError` attached) on schema mismatch                                              | Unit test              |
| 6   | Throws `FileSystemError` on `ENOENT`, `EACCES`, or other fs errors                                                  | Unit test              |
| 7   | Returns strictly typed `{ meta: T, content: string }` on success                                                    | TypeScript compilation |
| 8   | File located at `apps/web/src/lib/server/dal/loader.ts`                                                             | Code review            |

---

### S-DATA-03: Domain Data Repositories

**Story Points:** 3

**Dependencies:**

- S-DATA-01 completed
- S-DATA-02 completed

**Description:**
Implement specific repository modules for each content domain (`thoughts.ts`, `dreams.ts`) that utilize the generic loader. Define strict Zod schemas for each domain. Expose high-level accessors like `getAllThoughts()` and `getDreamBySlug()` that handle sorting and filtering logic.

**Acceptance Criteria:**

| #   | Criterion                                                                                                               | Verification Method |
| --- | ----------------------------------------------------------------------------------------------------------------------- | ------------------- | --------- |
| 1   | `ThoughtSchema` and `DreamSchema` defined and exported per Schema Definitions section                                   | Code review         |
| 2   | `getAllThoughts()` returns `Promise<Array<{ meta: Thought; content: string; slug: string }>>` sorted by date descending | Unit test           |
| 3   | `getThoughtBySlug(slug: string)` returns `Promise<{ meta: Thought; content: string }                                    | null>`              | Unit test |
| 4   | `getAllDreams()` returns `Promise<Array<{ meta: Dream; content: string; slug: string }>>` sorted by date descending     | Unit test           |
| 5   | `getDreamBySlug(slug: string)` returns `Promise<{ meta: Dream; content: string }                                        | null>`              | Unit test |
| 6   | Slug is derived from filename without extension (e.g., `2026-01-15-awakening.md` → `2026-01-15-awakening`)              | Code review         |
| 7   | Files located at `apps/web/src/lib/server/dal/repositories/thoughts.ts` and `dreams.ts`                                 | Code review         |

---

### S-DATA-04: Resilience & Error Handling Strategy

**Story Points:** 2

**Dependencies:**

- S-DATA-02 completed
- S-DATA-03 completed

**Description:**
Harden the DAL against malformed data and filesystem anomalies. Implement a "skip-and-log" strategy for `getAll` operations where individual corrupt files (bad syntax, missing required fields) are logged to `stderr` but do not crash the entire list retrieval. Ensure single-file retrieval returns `null` for missing files rather than throwing.

**Acceptance Criteria:**

| #   | Criterion                                                                                           | Verification Method              |
| --- | --------------------------------------------------------------------------------------------------- | -------------------------------- |
| 1   | `getAllThoughts()` skips files with Zod validation errors and continues processing                  | Unit test with mock corrupt file |
| 2   | Skipped files trigger a structured `console.error` log with filename and error details              | Log inspection                   |
| 3   | `FileSystemError` (permissions, I/O) is distinguished from `ValidationError` in logs                | Code review                      |
| 4   | Empty directories return empty arrays without throwing                                              | Unit test                        |
| 5   | `getBySlug` returns `null` for non-existent files (does not throw)                                  | Unit test                        |
| 6   | `getBySlug` throws `ValidationError` for files that exist but fail schema validation                | Unit test                        |
| 7   | Error classes defined in `apps/web/src/lib/server/dal/errors.ts` per Error Type Definitions section | Code review                      |

---

## Implementation Order

| Order | Story ID  | Story Title                          | Points | Dependencies |
| ----- | --------- | ------------------------------------ | ------ | ------------ |
| 1     | S-DATA-01 | Secure Path Resolution Primitive     | 3      | None         |
| 2     | S-DATA-02 | Generic Typed Content Loader         | 5      | S-DATA-01    |
| 3     | S-DATA-03 | Domain Data Repositories             | 3      | S-DATA-02    |
| 4     | S-DATA-04 | Resilience & Error Handling Strategy | 2      | S-DATA-03    |

**Total Story Points:** 13

---

## Out of Scope

The following are explicitly **not** part of this epic:

- Write operations to the filesystem (read-only DAL)
- Caching layer or memoization strategies
- HTTP API routes or REST endpoints (RSC direct access only)
- Repositories for `/sandbox`, `/projects`, `/visitors`, `/logs` domains
- Real-time file watching or change detection
- Search or full-text indexing
- Pagination for large directories

---

## Definition of Done

- [ ] All four stories completed with acceptance criteria met
- [ ] `pnpm typecheck` passes with no errors
- [ ] `pnpm lint` passes with no warnings
- [ ] `pnpm test` passes with all DAL unit tests green
- [ ] `tools/protocol-zero.sh` passes on all changed files
- [ ] Code imports `server-only` in all DAL modules
- [ ] No hardcoded color values or AI attribution artifacts
- [ ] PR approved by reviewer following No-AI policy scan (per CLAUDE.md Section 1)

---

## References

- [Zod Documentation](https://zod.dev/)
- [gray-matter npm](https://www.npmjs.com/package/gray-matter)
- [Vitest Documentation](https://vitest.dev/)
- [Next.js Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components)
- E0-INFRA-01: Containerized Filesystem Parity (prerequisite epic)

---

_This epic is governed by CLAUDE.md. Any conflicts with other documentation are resolved in favor of CLAUDE.md._
